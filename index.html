<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Steam Friends — Web-Only Finder</title>
<style>
  body { font-family: Arial,sans-serif; background:#0f1724; color:#e6eef8; display:flex; justify-content:center; padding:20px;}
  .wrap { width: 600px; background:#0b1220; border-radius:12px; padding:20px; }
  input, button { padding:10px; border-radius:8px; border:none; font-size:14px; margin-top:6px; width:100%;}
  button { cursor:pointer; background:#3b82f6; color:#fff; font-weight:600;}
  table { width:100%; border-collapse:collapse; margin-top:12px;}
  th, td { padding:8px; text-align:left; border-bottom:1px solid #1a2030; font-size:13px;}
  img.avatar { width:32px; height:32px; border-radius:5px; vertical-align:middle; object-fit:cover;}
  td a { color:#60a5fa; text-decoration:none; }
</style>
</head>
<body>
  <div class="wrap">
    <h2>Steam Friends — Web-Only Finder</h2>
    <p>Enter your SteamID64 or vanity URL (public profile only):</p>
    <input id="steamId" placeholder="SteamID64 or vanity name"/>
    <button id="startBtn">Load Friends</button>

    <table id="table" hidden>
      <thead>
        <tr><th>Avatar</th><th>Friend</th><th>Level</th><th>Profile</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
document.getElementById('startBtn').addEventListener('click', async () => {
  const steamId = document.getElementById('steamId').value.trim();
  if (!steamId) { alert('Enter SteamID64 or vanity URL'); return; }

  const proxy = "/api/proxy?url=";

  const table = document.getElementById('table');
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  table.hidden = false;

  try {
    // Convert vanity to SteamID64 if needed
    let steamID64 = steamId;
    if (isNaN(steamId)) {
      const res = await fetch(proxy + encodeURIComponent(`https://steamcommunity.com/id/${steamId}/?xml=1`));
      const txt = await res.text();
      const match = txt.match(/<steamID64>(\d+)<\/steamID64>/);
      if (!match) throw new Error("Invalid vanity URL or private profile");
      steamID64 = match[1];
    }

    // Fetch friends HTML
    const friendsRes = await fetch(proxy + encodeURIComponent(`https://steamcommunity.com/profiles/${steamID64}/friends/`));
    const html = await friendsRes.text();

    // Extract friend entries
    const friends = [...html.matchAll(/data-steamid="(\d+)".*?friend_block_content">([^<]+)/gms)];

    if (!friends.length) {
      alert("No friends found or profile is private.");
      return;
    }

    for (let match of friends) {
      const friendID = match[1];
      const friendName = match[2].trim();
      const profileUrl = `https://steamcommunity.com/profiles/${friendID}`;

      // extract avatar URL (small thumbnail)
      const imgRegex = new RegExp(`data-steamid="${friendID}".*?<img[^>]+src="([^"]+)"`, "s");
      const imgMatch = imgRegex.exec(html);
      const avatar = imgMatch ? imgMatch[1].replace(".jpg", "_thumb.jpg") : "https://steamcommunity-a.akamaihd.net/public/images/avatars/default.jpg";

      // extract steam level if present
      const lvlRegex = new RegExp(`data-steamid="${friendID}".*?friendPlayerLevelNum">(\\d+)`, "s");
      const lvlMatch = lvlRegex.exec(html);
      const level = lvlMatch ? lvlMatch[1] : "?";

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><img class="avatar" src="${avatar}" alt="avatar"></td>
        <td>${friendName}</td>
        <td>${level}</td>
        <td><a href="${profileUrl}" target="_blank">View Profile</a></td>
      `;
      tbody.appendChild(tr);
    }

  } catch (e) {
    alert("Error: " + e.message);
  }
});
</script>
</body>
</html>
