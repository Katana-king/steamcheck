<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Steam Friends — No API</title>
<style>
  body { font-family: Arial, sans-serif; background:#0f1724; color:#e6eef8; display:flex; justify-content:center; padding:20px; }
  .wrap { width:650px; background:#0b1220; border-radius:12px; padding:20px; }
  input, button { padding:10px; border-radius:8px; border:none; font-size:14px; margin-top:6px; width:100%; }
  button { cursor:pointer; background:#3b82f6; color:#fff; font-weight:600; }
  table { width:100%; border-collapse:collapse; margin-top:14px; text-align:left; }
  th, td { padding:8px; border-bottom:1px solid #1f2a3d; font-size:14px; }
  img.avatar { width:32px; height:32px; border-radius:5px; }
  .loading { color:#94a3b8; }
</style>
</head>
<body>
<div class="wrap">

<h2>Steam Friends — Finder (No API Key)</h2>
<p>Enter SteamID64 or vanity URL:</p>
<input id="steamInput" placeholder="Example: 76561198xxxxxx or gaben">
<button id="loadBtn">Load Friends</button>

<table id="results" hidden>
  <thead>
    <tr><th>Avatar</th><th>Friend</th><th>Level</th><th>Profile</th></tr>
  </thead>
  <tbody id="tblBody"></tbody>
</table>

</div>

<script>
const proxy = "/api/proxy?url="; // Vercel serverless proxy

document.getElementById("loadBtn").addEventListener("click", async () => {
    const input = document.getElementById("steamInput").value.trim();
    if (!input) return alert("Enter a SteamID or vanity profile name!");

    document.getElementById("results").hidden = false;
    const tbody = document.getElementById("tblBody");
    tbody.innerHTML = "";

    let steamID64 = input;

    try {
        // Convert vanity to SteamID64
        if (isNaN(input)) {
            const xmlTxt = await (await fetch(proxy + encodeURIComponent(`https://steamcommunity.com/id/${input}/?xml=1`))).text();
            const match = xmlTxt.match(/<steamID64>(\d+)<\/steamID64>/);
            if (!match) throw new Error("Invalid vanity URL or private profile.");
            steamID64 = match[1];
        }

        // Fetch friends HTML page
        const html = await (await fetch(proxy + encodeURIComponent(`https://steamcommunity.com/profiles/${steamID64}/friends/`))).text();

        // Extract friends by dataset steamid
        const friendIDs = [...html.matchAll(/data-steamid="(\d+)"/g)].map(m => m[1]);
        if (!friendIDs.length) throw new Error("Could not read friends list — might be private.");

        for (let friendID of friendIDs) {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td><img class="avatar" src="https://avatars.steamstatic.com/${friendID.slice(-2)}/${friendID}_medium.jpg" onerror="this.src='https://community.cloudflare.steamstatic.com/public/images/avatars/ee/eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee.jpg'"></td>
              <td class="name">Loading…</td>
              <td class="lvl loading">Loading…</td>
              <td><a href="https://steamcommunity.com/profiles/${friendID}" target="_blank">View</a></td>
            `;
            tbody.appendChild(row);

            // Fetch nickname + level from profile
            fetchFriendProfile(friendID, row);
        }

    } catch(err) {
        alert(err.message);
    }
});

async function fetchFriendProfile(id, row) {
    try {
        const profileHTML = await (await fetch(proxy + encodeURIComponent(`https://steamcommunity.com/profiles/${id}`))).text();

        const nameMatch = profileHTML.match(/<span class="actual_persona_name">([^<]+)</);
        const levelMatch = profileHTML.match(/class="friendPlayerLevelNum">(\d+)</);

        const nameCell = row.querySelector(".name");
        const lvlCell = row.querySelector(".lvl");

        nameCell.textContent = nameMatch ? nameMatch[1].trim() : "Unknown";
        lvlCell.textContent = levelMatch ? levelMatch[1] : "?";
        lvlCell.classList.remove("loading");

    } catch {
        row.querySelector(".name").textContent = "Unknown";
        row.querySelector(".lvl").textContent = "?";
    }
}
</script>
</body>
</html>
